<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>처리 중…</title>
  <style>
    html,body{height:100%;margin:0}
    body{display:grid;place-items:center;font-family:system-ui,Apple SD Gothic Neo,sans-serif}
    .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;max-width:640px;padding:0 16px;text-align:center}
    .spinner{width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .sub{color:#4b5563;font-size:14px;line-height:1.5}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="spinner" aria-hidden="true"></div>
    <div class="sub" id="progressMsg">
      AI가 기록을 정리하고 있습니다 (평균 20~40초).<br>
      <strong>이 페이지를 닫지 마세요.</strong>
    </div>
  </div>

  <script>
    const sid = new URLSearchParams(location.search).get('sid') || '';
    if (!sid) location.replace('/fail');

    // 5초 간격 메시지 (0~30초, 총 7단계)
    const messages = [
      "AI가 기록을 정리하고 있습니다 (평균 20~40초).<br><strong>이 페이지를 닫지 마세요.</strong>",
      "입력하신 내용을 요약하고 있어요…",
      "감정을 분석하는 중입니다…",
      "맞춤 피드백을 준비하고 있습니다…",
      "마지막 점검 중입니다…",
      "곧 결과가 표시됩니다. 잠시만 기다려주세요.",
      "이 창은 곧 자동으로 전환됩니다."
    ];

    const msgEl = document.getElementById("progressMsg");
    let idx = 0;
    const iv = setInterval(() => {
      idx++;
      if (idx < messages.length) {
        msgEl.innerHTML = messages[idx];
      } else {
        clearInterval(iv); // 30초 이후에는 마지막 문구 유지
      }
    }, 5000);

    async function poll() {
      try {
        const r = await fetch(`/api/status?sid=${encodeURIComponent(sid)}`, { cache: 'no-store' });
        if (!r.ok) throw new Error('bad status');
        const { status, emotion_entry_id } = await r.json();

        if (status === 'ready' && emotion_entry_id) {
          clearInterval(iv);
          location.replace(`/feedback?emotion_entry_id=${encodeURIComponent(emotion_entry_id)}`);
        } else if (status === 'fail' || status === 'error') {
          clearInterval(iv);
          location.replace('/fail');
        } else {
          setTimeout(poll, 1200);
        }
      } catch {
        setTimeout(poll, 1500);
      }
    }
    poll();
  </script>
</body>
</html>